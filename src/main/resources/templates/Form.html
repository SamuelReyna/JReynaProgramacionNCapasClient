<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

    <body layout:fragment="body">
        <div class="container m-4 cormorant-garamond">
            <div class="row">
                <form method="POST" th:object="${usuario}" th:action="@{/usuario/add}"
                      enctype="multipart/form-data"
                      class="needs-validation g-3">

                    <input type="hidden" th:field="*{idUser}" id="idUser" />
                    <input type="hidden" th:field="*{Direcciones[0].idDireccion}" id="idDireccion" /> 
                    <h5 
                        th:if="${(usuario.IdUser == 0 && usuario.Direcciones[0].IdDireccion == 0)}"
                        class="mt-3 mb-3">Registrar Usuario</h5>
                    <h5 
                        th:if="${(usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion == -1)}"
                        class="mt-3 mb-3">Editar Usuario</h5>

                    <!-- ================= USUARIO ================= -->
                    <!-- Imagen -->
                    <div class="col-6">
                        <div class="custom-file" id="group-file-input"  >
                            <input type="file" name="imagenFile" class="custom-file-input" id="fileInput"/>
                            <label class="custom-file-label" for="imagenFile">Choose file</label>
                        </div>
                    </div>

                    <div class="usuario row g-3"
                         th:if="${(usuario.IdUser == 0 && usuario.Direcciones[0].IdDireccion == 0) ||
                         (usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion == -1)}">

                        <!-- Username -->
                        <div class="col-6">
                            <label class="form-label" for="username">Usuario</label>
                            <div class="input-group">
                                <span class="input-group-text">@</span>
                                <input type="text" class="form-control" placeholder="Username" th:field="*{Username}" id="username">
                            </div>
                            <span class="err-msg text-danger small"></span>
                        </div>

                        <!-- Nombre -->
                        <div class="col-md-6">
                            <label class="form-label" for="nombre">Nombre(s)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-file-person"></i></span>
                                <input type="text" class="form-control" placeholder="Nombre(s)" th:field="*{NombreUsuario}" id="nombre">
                            </div>
                            <span class="err-msg text-danger small" th:if="${#fields.hasErrors('NombreUsuario')}" th:errors="*{NombreUsuario}"></span>
                        </div>

                        <!-- Apellidos -->
                        <div class="col-md-3">
                            <label class="form-label" for="apellidoPaterno">Apellido Paterno</label>
                            <input type="text" class="form-control" placeholder="Apellido Paterno" th:field="*{ApellidoPaterno}" id="apellidoPaterno">
                            <span class="err-msg text-danger small" th:if="${#fields.hasErrors('ApellidoPaterno')}" th:errors="*{ApellidoPaterno}"></span>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="apellidoMaterno">Apellido Materno</label>
                            <input type="text" class="form-control" placeholder="Apellido Materno" th:field="*{ApellidoMaterno}" id="apellidoMaterno">
                            <span class="err-msg text-danger small" th:if="${#fields.hasErrors('ApellidoMaterno')}" th:errors="*{ApellidoMaterno}"></span>
                        </div>

                        <!-- Contraseñas -->
                        <div class="col-md-6">
                            <label class="form-label" for="password">Contraseña</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                <input type="password" class="form-control" placeholder="Contraseña" th:field="*{Password}" id="password">
                            </div>
                            <small class="err-msg text-danger small" id="password-msg"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="confirmPassword">Confirmar contraseña</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                <input type="password" class="form-control" placeholder="Confirmar contraseña" id="confirmPassword">
                            </div>
                            <small class="err-msg text-danger small" id="confirmPassword-msg"></small>
                        </div>

                        <!-- Teléfonos -->
                        <div class="col-md-6">
                            <label class="form-label" for="telefono">Teléfono</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-telephone-forward-fill"></i></span>
                                <input type="text" class="form-control" placeholder="Teléfono" th:field="*{Telefono}" id="telefono">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="celular">Celular</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-phone-fill"></i></span>
                                <input type="text" class="form-control" placeholder="Celular" th:field="*{Celular}" id="celular">
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="col-12">
                            <label class="form-label" for="email">Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope-at-fill"></i></span>
                                <input type="email" class="form-control" placeholder="Email" th:field="*{Email}" id="email">
                            </div>
                            <span class="err-msg text-danger small" th:if="${#fields.hasErrors('Email')}" th:errors="*{Email}"></span>
                        </div>

                        <!-- Fecha y Sexo -->
                        <div class="col-md-6">
                            <label class="form-label" for="fechaNacimiento">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" th:field="*{FechaNacimiento}"  id="fechaNacimiento">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Sexo</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="genero" id="masculino" th:value="'M'" th:field="*{Sexo}">
                                <label class="btn btn-outline-secondary" for="masculino">Masculino</label>

                                <input type="radio" class="btn-check" name="genero" id="femenino" th:value="'F'" th:field="*{Sexo}">
                                <label class="btn btn-outline-secondary" for="femenino">Femenino</label>
                            </div>
                        </div>

                        <!-- CURP y Rol -->
                        <div class="col-md-6">
                            <label class="form-label" for="curp">CURP</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-person-video2"></i></span>
                                <input type="text" class="form-control" placeholder="CURP" th:field="*{Curp}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="rol">Rol</label>
                            <select class="form-select" th:field="*{Rol.IdRol}" id="rol">
                                <option value="0" selected disabled>Rol</option>
                            </select>
                        </div>
                    </div>

                    <!-- ================= DIRECCIÓN ================= -->
                    <div class="direccion row g-3"
                         th:if="${(usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion == 0)
                         || (usuario.IdUser == 0 && usuario.Direcciones[0].IdDireccion == 0 )
                         || (usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion != 0 )
                         
                         }">

                        <h5 
                            th:if="${(usuario.IdUser == 0 && usuario.Direcciones[0].IdDireccion ==0) ||
                            (usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion == 0)}"
                            class="mt-3 mb-3">Registrar dirección</h5>
                        <h5 
                            th:if="${(usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion !=0 && usuario.Direcciones[0].IdDireccion != -2) ||
                            (usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion == -1)}"
                            class="mt-3 mb-3">Editar dirección</h5>

                        <div class="col-12">
                            <label class="form-label">Calle</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-house-door-fill"></i></span>
                                <input type="text" class="form-control" placeholder="Calle" th:field="*{Direcciones[0].Calle}">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Num. Ext.</label>
                            <input type="text" class="form-control" placeholder="Num. Ext." th:field="*{Direcciones[0].NumeroExterior}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Num. Int. (Opcional)</label>
                            <input type="text" class="form-control" placeholder="Num. Int. (Opcional)" th:field="*{Direcciones[0].NumeroInterior}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">País</label>
                            <select class="form-select" id="pais" th:field="*{Direcciones[0].Colonia.Municipio.Estado.Pais.idPais}">
                                <option value="0" selected disabled>País</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="estado" th:field="*{Direcciones[0].Colonia.Municipio.Estado.idEstado}">
                                <option value="0" selected disabled>Estado</option>
                                <!--                                <option th:each="estado : ${Estados}" th:value="${estado.IdEstado}" th:text="${estado.Nombre}"></option>-->
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Municipio</label>
                            <select class="form-select" id="municipio" th:field="*{Direcciones[0].Colonia.Municipio.IdMunicipio}">
                                <option value="0" selected disabled>Municipio</option>
                                <!--<option th:each="municipio : ${Municipios}" th:value="${municipio.IdMunicipio}" th:text="${municipio.Nombre}"></option>-->
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Colonia</label>
                            <select class="form-select" id="colonia" th:field="*{Direcciones[0].Colonia.IdColonia}">
                                <option value="0" selected disabled>Colonia</option>
                                <!--                                <option th:each="colonia : ${Colonias}" th:value="${colonia.IdColonia}" th:text="${colonia.Nombre}"></option>-->
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Código Postal</label>
                            <input type="text" id="cp" class="form-control" placeholder="Código Postal" th:field="*{Direcciones[0].Colonia.codigoPostal}" disabled>
                        </div>
                    </div>

                    <!-- ================= BOTÓN GUARDAR ================= -->
                    <div class="col-12 mt-3">
                        <button
                            th:if="${(usuario.IdUser == 0 && usuario.Direcciones[0].IdDireccion ==0) ||
                            (usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion == 0)}"
                            type="submit" class="btn btn-primary w-100">Agregar</button>

                        <button 
                            th:if="${(usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion !=0 && usuario.Direcciones[0].IdDireccion != -2) ||
                            (usuario.IdUser != 0 && usuario.Direcciones[0].IdDireccion == -1)}"
                            type="submit" class="btn btn-primary w-100">Guardar</button>
                    </div>
                </form>
            </div>



            <script>
                $(document).ready(function () {
                    $(
                            "#nombre, #apellidoPaterno, #apellidoMaterno, #password, #confirmPassword, #username"
                            ).on("paste", function (e) {
                        e.preventDefault();
                    });
                    function OnlyLetters(event, input) {
                        let key = event.key;
                        let regex = new RegExp(/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/);
                        if (!regex.test(key)) {
                            event.preventDefault();
                            $(input).removeClass("border-success").addClass("border-danger");
                            $(input)
                                    .parent("div")
                                    .siblings(".err-msg")
                                    .text("Solo se permiten letras");
                        } else {
                            $(input).removeClass("border-danger").addClass("border-success");
                            $(input).parent("div").siblings(".err-msg").text("");
                        }
                    }
                    $("#nombre, #apellidoPaterno, #apellidoMaterno").keydown(function (
                            event
                            ) {
                        OnlyLetters(event, this);
                    });
                });
                $(document).ready(function () {
                    function validatePasswords() {
                        let regex = new RegExp(
                                /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/
                                );
                        let password = $("#password").val();
                        let confirmPassword = $("#confirmPassword").val();
                        if (password.length > 0) {
                            if (regex.test(password)) {
                                $("#password-msg")
                                        .text("Contraseña válida")
                                        .removeClass("text-danger")
                                        .addClass("text-success");
                                console.log("La contraseña es válida");
                            } else {
                                $("#password-msg")
                                        .text(
                                                "Debe tener al menos 8 caracteres, una mayúscula, una minúscula, un número y un símbolo"
                                                )
                                        .removeClass("text-success")
                                        .addClass("text-danger");
                                console.log("La contraseña no es válida");
                            }
                        }
                        if (confirmPassword.length > 0) {
                            if (password === confirmPassword) {
                                $("#confirmPassword-msg")
                                        .text("Las contraseñas coinciden")
                                        .removeClass("text-danger")
                                        .addClass("text-success");
                                console.log("La contraseña coincide.");
                            } else {
                                $("#confirmPassword-msg")
                                        .text("Las contraseñas no coinciden")
                                        .removeClass("text-success")
                                        .addClass("text-danger");
                                console.log("La contraseña no coinciden");
                            }
                        }
                    }
                    $("#password, #confirmPassword").on("input", validatePasswords);
                });
                $(document).ready(function () {
                    function validateUsername() {
                        let regex = new RegExp(
                                /^(?=.{3,16}$)(?![_0-9])[a-zA-Z0-9_]+(?<!_)$/
                                );
                        let username = $("#username").val();
                        if (username.length > 0) {
                            if (regex.test(username)) {
                                $("#username")
                                        .removeClass("border-danger")
                                        .addClass("border-success");
                                $("#username").parent("div").siblings(".err-msg").text("");
                            } else {
                                $("#username")
                                        .removeClass("border-success")
                                        .addClass("border-danger");
                                $("#username")
                                        .parent("div")
                                        .siblings(".err-msg")
                                        .text("Formato no válido");
                            }
                        }
                    }
                    $("#username").on("input", validateUsername);
                });
                $(document).ready(function () {
                    $("#telefono, #celular")
                            .on("paste", function (e) {
                                e.preventDefault();
                            })
                            .on("input", function () {
                                let input = $(this).val();
                                input = input.replace(/\D/g, "");
                                if (input.length > 10) {
                                    input = input.substring(0, 10);
                                }

                                if (input.length > 6 && input.length <= 10) {
                                    input =
                                            "(" +
                                            input.substr(0, 3) +
                                            ")" +
                                            input.substr(3, 6) +
                                            "-" +
                                            input.substr(6, 10);
                                } else if (input.length > 3) {
                                    input = "(" + input.substr(0, 3) + ")" + input.substr(3);
                                } else if (input.length > 0) {
                                    input = "(" + input;
                                }
                                $(this).val(input);
                            });
                });
                $(document).ready(function () {
                    function validateEmail() {
                        let regex = new RegExp(
                                /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/
                                );
                        input = $("#email").val();
                        if (regex.test(input)) {
                            $("#email")
                                    .removeClass("border-danger")
                                    .addClass("border-success");
                            $("#email").parent("div").siblings(".err-msg").text("");
                        } else {
                            $("#email")
                                    .removeClass("border-success")
                                    .addClass("border-danger");
                            $("#email")
                                    .parent("div")
                                    .siblings(".err-msg")
                                    .text("Formato no válido");
                        }
                    }
                    $("#email").on("input", validateEmail);
                });
                $(document).ready(function () {
                    function validateDate() {
                        fechaInput = $("#fechaNacimiento").val();

                        const partes = fechaInput.split("-");
                        const dia = parseInt(partes[2], 10);
                        const mes = parseInt(partes[1], 10) - 1;
                        const anio = parseInt(partes[0], 10);
                        const fecha = new Date(anio, mes, dia);
                        console.log(fecha);
                        console.log(fechaInput);
                        const hoy = new Date();
                        if (
                                fecha.getDate() !== dia ||
                                fecha.getMonth() !== mes ||
                                fecha.getFullYear() !== anio
                                ) {
                            $("#fechaNacimiento")
                                    .parent("div")
                                    .siblings(".err-msg")
                                    .text("La fecha no es válida");
                            $("#fechaNacimiento")
                                    .removeClass("border-success")
                                    .addClass("border-danger");
                        } else if (fecha > hoy) {
                            $("#fechaNacimiento")
                                    .parent("div")
                                    .siblings(".err-msg")
                                    .text("La fecha no puede ser futura");
                            $("#fechaNacimiento")
                                    .removeClass("border-success")
                                    .addClass("border-danger");
                        } else if (hoy.getFullYear() - anio > 120) {
                            $("#fechaNacimiento")
                                    .parent("div")
                                    .siblings(".err-msg")
                                    .text("La fecha no puede ser más de 120 años");
                            $("#fechaNacimiento")
                                    .removeClass("border-success")
                                    .addClass("border-danger");
                        } else {
                            $("#fechaNacimiento")
                                    .removeClass("border-danger")
                                    .addClass("border-success");
                            $("#fechaNacimiento").parent("div").siblings(".err-msg").text("");
                        }
                    }
                    $("#fechaNacimiento").on("input", validateDate);
                });

                function cleanForm() {
                    $("input").removeClass("border-danger").removeClass("border-success");
                    $(".err-msg ").text("");
                    $("input").val("");
                    $("select").val(0);

                    $("form").find('input[type="radio"]').prop("checked", false);
                }
                $(document).on("keydown", function (event) {
                    if (event.key === "Escape" || event.key === "Esc") {
                        cleanForm();
                    }
                });

                $(document).ready(function () {
                    $("#pais").change(function () {
                        $.ajax({
                            type: "GET",
                            url: `http://localhost:8080/api/estado/byPais/${$("#pais").val()}`,
                            dataType: "JSON",
                            success: function (data, textStatus, jqXHR) {
                                if (data.correct) {
                                    $("#estado")
                                            .empty()
                                            .append(
                                                    '<option value="0" selected disabled >Estado</option>'
                                                    );
                                    $.each(data.objects, function (indice, estado) {
                                        $("#estado").append(
                                                `<option value='${estado.idEstado}'>${estado.nombre}</option>`
                                                );
                                    });
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                alert("something went wrong");
                            }
                        });
                    });
                    $("#estado").change(function () {
                        $.ajax({
                            type: "GET",
                            url: `http://localhost:8080/api/municipio/byEstado/${$("#estado").val()}`,
                            dataType: "JSON",
                            success: function (data, textStatus, jqXHR) {
                                if (data.correct) {
                                    $("#municipio")
                                            .empty()
                                            .append(
                                                    '<option value="0" selected disabled >Municipio</option>'
                                                    );
                                    $.each(data.objects, function (indice, municipio) {
                                        $("#municipio").append(
                                                `<option value='${municipio.idMunicipio}'>${municipio.nombre}</option>`
                                                );
                                    });
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                alert("something went wrong");
                            }
                        });
                    });
                    $("#municipio").change(function () {
                        $.ajax({
                            type: "GET",
                            url: `http://localhost:8080/api/colonia/byMunicipio/${$("#municipio").val()}`,
                            dataType: "JSON",
                            success: function (data, textStatus, jqXHR) {
                                if (data.correct) {
                                    $("#cp").val("");
                                    $("#colonia")
                                            .empty()
                                            .append(
                                                    '<option value="0" selected disabled >Colonia</option>'
                                                    );
                                    $.each(data.objects, function (indice, colonia) {
                                        $("#colonia").append(
                                                `<option value='${colonia.idColonia}'>${colonia.nombre}</option>`
                                                );
                                        $("#colonia").change(function () {
                                            $("#cp").val(colonia.codigoPostal);
                                        });
                                    });
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                alert("something went wrong");
                            },
                        });
                    });
                });

                $(document).ready(function () {
                    $("form").on("submit", function (e) {
                        $("#nombre, #apellidoPaterno, #apellidoMaterno").trigger("keydown");
                        $("#password, #confirmPassword").trigger("input");
                        $("#username").trigger("input");
                        $("#email").trigger("input");
                        $("#fechaNacimiento").trigger("input");

                        if ($(".border-danger").length > 0) {
                            e.preventDefault();
                            alert("Datos no validos");
                        }
                    });
                });

                $(document).ready(function () {
                    let idUser = $("#idUser").val();
                    let idDireccion = $("#idDireccion").val();

                    if ((idUser != 0 && idDireccion != 0 && idDireccion != -1) || (idUser != 0 && idDireccion == 0)) {
                        $("#group-file-input").css("display", "none");
                    }
                });

                $(document).ready(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/rol",
                        type: "GET",
                        success: function (response) {
                            $.each(response.objects, function (indice, rol) {
                                $('#rol').append(
                                        `<option value='${rol.idRol}'>${rol.nombre}</option>`
                                        );
                            });
                        },
                        error: function (error) {
                            console.error('Error:', error);
                        }
                    });
                });
                $(document).ready(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/pais",
                        type: "GET",
                        success: function (response) {
                            $.each(response.objects, function (indice, pais) {
                                $('#pais').append(
                                        `<option value='${pais.idPais}'>${pais.nombre}</option>`
                                        );
                            });
                        },
                        error: function (error) {
                            console.error('Error:', error);
                        }
                    });
                });
                $(document).ready(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/estado",
                        type: "GET",
                        success: function (response) {
                            $.each(response.objects, function (indice, estado) {
                                $('#estado').append(
                                        `<option value='${estado.idEstado}'>${estado.nombre}</option>`
                                        );
                            });
                        },
                        error: function (error) {
                            console.error('Error:', error);
                        }
                    });
                });
                $(document).ready(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/municipio",
                        type: "GET",
                        success: function (response) {
                            $.each(response.objects, function (indice, municipio) {
                                $('#municipio').append(
                                        `<option value='${municipio.idMunicipio}'>${municipio.nombre}</option>`
                                        );
                            });
                        },
                        error: function (error) {
                            console.error('Error:', error);
                        }
                    });
                });
                $(document).ready(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/colonia",
                        type: "GET",
                        success: function (response) {
                            console.log(response);
                            $.each(response.objects, function (indice, colonia) {
                                $('#colonia').append(
                                        `<option value='${colonia.idColonia}'>${colonia.nombre} </option>`
                                        );
                                $("#colonia").change(function () {
                                    $("#cp").val(colonia.codigoPostal);
                                });
                            });
                        },
                        error: function (error) {
                            console.error('Error:', error);
                        }
                    });
                });

            </script>
        </div>
    </body>
</html>
